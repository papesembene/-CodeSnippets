#!/usr/bin/env php
<?php

/**
 * Script de seeding de base de donn√©es
 */

require_once __DIR__ . '/../vendor/autoload.php';

// Charger les variables d'environnement
require_once __DIR__ . '/../App/config/env.php';
EnvLoader::load();

use App\Core\DataBase;

echo "üå± D√©marrage du seeding...\n\n";

try {
    // Connexion √† la base de donn√©es
    echo "üì° Connexion √† PostgreSQL...\n";
    $db = DataBase::getInstance();
    $connection = $db->getConnection();
    echo "‚úÖ Connexion r√©ussie!\n\n";

    // Cr√©er la table des seeds si elle n'existe pas
    echo "üìã V√©rification de la table des seeds...\n";
    $seedTableSql = "
        CREATE TABLE IF NOT EXISTS seeds (
            id SERIAL PRIMARY KEY,
            seeder VARCHAR(255) NOT NULL UNIQUE,
            executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
    ";
    $connection->exec($seedTableSql);
    echo "‚úÖ Table seeds OK!\n\n";

    // Lister les seeds d√©j√† ex√©cut√©s
    $stmt = $connection->query("SELECT seeder FROM seeds ORDER BY executed_at");
    $executedSeeders = $stmt->fetchAll(PDO::FETCH_COLUMN);

    // Scanner le dossier des seeders
    $seedersDir = __DIR__ . '/../database/seeders/';
    $seederFiles = glob($seedersDir . '*.php');
    sort($seederFiles);

    $newSeeders = 0;

    foreach ($seederFiles as $seederFile) {
        $seederName = basename($seederFile, '.php');
        
        // V√©rifier si le seeder a d√©j√† √©t√© ex√©cut√©
        if (in_array($seederName, $executedSeeders)) {
            echo "‚è© Seeder d√©j√† ex√©cut√©: $seederName\n";
            continue;
        }

        echo "üîÑ Ex√©cution du seeder: $seederName\n";
        
        try {
            // Inclure et ex√©cuter le seeder
            require_once $seederFile;
            
            // Cr√©er une instance de la classe seeder
            $className = "App\\Seeders\\$seederName";
            if (class_exists($className)) {
                $seeder = new $className();
                $seeder->run();
                
                // Enregistrer le seeder comme ex√©cut√©
                $stmt = $connection->prepare("INSERT INTO seeds (seeder) VALUES (?)");
                $stmt->execute([$seederName]);
                
                echo "‚úÖ Seeder r√©ussi: $seederName\n";
                $newSeeders++;
            } else {
                echo "‚ö†Ô∏è  Classe $className non trouv√©e dans $seederFile\n";
            }
            
        } catch (Exception $e) {
            echo "‚ùå Erreur dans le seeder $seederName: " . $e->getMessage() . "\n";
            exit(1);
        }
    }

    if ($newSeeders === 0) {
        echo "\nüì¢ Aucun nouveau seeder √† ex√©cuter.\n";
    } else {
        echo "\nüéâ $newSeeders seeder(s) ex√©cut√©(s) avec succ√®s!\n";
    }

} catch (Exception $e) {
    echo "‚ùå Erreur g√©n√©rale: " . $e->getMessage() . "\n";
    exit(1);
}

echo "\n‚ú® Seeding termin√©!\n";
